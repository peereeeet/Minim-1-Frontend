<div class="evento-container">
  <!-- Formulario de evento -->
  <div class="evento-form">
    <form (ngSubmit)="onSubmit()">
      <div class="form-header">
        <h2>Crear nuevo evento</h2>
        <button type="button" class="btn-back" (click)="goHome()">
          â† Volver a Home
        </button>
      </div>

      <div class="form-group">
        <label for="name" class="form-label">TÃ­tulo del evento:</label>
        <input
          id="name"
          class="form-input"
          type="text"
          [(ngModel)]="newEvent.name"
          name="name"
          placeholder="Ej: ReuniÃ³n de planificaciÃ³n Q4"
          required />
        <div class="error-message" *ngIf="errorMessage && errorMessage.includes('tÃ­tulo')">
          {{ errorMessage }}
        </div>
      </div>

      <div class="form-two-col">
        <div class="left-col">
          <div class="form-group">
            <label class="form-label">Horario del evento:</label>
            <div class="schedule-row">
              <input 
                type="date" 
                class="form-input"
                [(ngModel)]="dateStr" 
                name="dateStr" 
                aria-label="Fecha" />
              <input 
                type="time" 
                class="form-input"
                [(ngModel)]="timeStr" 
                name="timeStr" 
                aria-label="Hora" />
              <button type="button" (click)="setSchedule()" class="add-slot">
                ğŸ“… Establecer horario
              </button>

              <button
                type="button"
                *ngIf="newEvent.schedule && newEvent.schedule !== ''"
                (click)="clearSchedule()"
                class="remove-slot">
                âŒ Quitar
              </button>
            </div>

            <div class="schedule-preview">
              <strong>Seleccionado: </strong>
              <span *ngIf="newEvent.schedule; else noHorario">
                {{ getScheduleText(newEvent) }}
              </span>
              <ng-template #noHorario><em>Sin horario establecido</em></ng-template>
            </div>
          </div>

          <div class="form-group">
            <label for="address" class="form-label">DirecciÃ³n:</label>
            <input
              id="address"
              class="form-input"
              type="text"
              [(ngModel)]="newEvent.address"
              name="address"
              placeholder="Ej: C/ Mallorca 123, Barcelona" />
          </div>
        </div>

        <div class="right-col">
          <div class="participants-wrapper">
            <!-- Usuarios disponibles -->
            <div class="participants-column">
              <div class="list-header">
                <h4>ğŸ‘¥ Usuarios disponibles</h4>
              </div>

              <div class="pager">
                <button type="button" (click)="availablePrevPage()" [disabled]="availablePage<=1">Â«</button>
                <span class="counter">PÃ¡gina {{ availablePage }} / {{ availableTotalPages }}</span>
                <button type="button" (click)="availableNextPage()" [disabled]="availablePage>=availableTotalPages">Â»</button>
                <span class="total">Total: {{ availableUsers.length }}</span>
              </div>

              <div class="user-row" *ngFor="let u of availablePageItems">
                <span class="user-name">{{ u.username }}</span>
                <button type="button" (click)="addParticipant(u)" class="btn-add">â• AÃ±adir</button>
              </div>
              <div class="empty" *ngIf="!availableUsers.length">
                âœ… Todos los usuarios estÃ¡n en el evento
              </div>
            </div>

            <!-- Participantes del evento -->
            <div class="participants-column">
              <div class="list-header">
                <h4>ğŸ¯ Participantes del evento</h4>
              </div>

              <div class="pager">
                <button type="button" (click)="selectedPrevPage()" [disabled]="selectedPage<=1">Â«</button>
                <span class="counter">PÃ¡gina {{ selectedPage }} / {{ selectedTotalPages }}</span>
                <button type="button" (click)="selectedNextPage()" [disabled]="selectedPage>=selectedTotalPages">Â»</button>
                <span class="total">Total: {{ selectedUsers.length }}</span>
              </div>

              <div class="user-row" *ngFor="let u of selectedPageItems">
                <span class="user-name">{{ u.username }}</span>
                <button type="button" (click)="removeParticipant(u)" class="btn-remove">â– Quitar</button>
              </div>
              <div class="empty" *ngIf="!selectedUsers.length">
                â„¹ï¸ Nadie apuntado aÃºn
              </div>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" (click)="formSubmitted = true">ğŸ’¾ Guardar Evento</button>
    </form>

    <div class="error-message" *ngIf="errorMessage">
      âš ï¸ {{ errorMessage }}
    </div>
  </div>

  <!-- Lista de eventos -->
  <div class="evento-list">
    <h1>Lista de Eventos</h1>
    
    <div *ngIf="eventos.length === 0" class="empty-state">
      <div class="empty-icon">ğŸ“…</div>
      <h3>No hay eventos programados</h3>
      <p>Comienza creando el primer evento del sistema</p>
    </div>

    <ul *ngIf="eventos.length > 0">
      <li *ngFor="let evento of eventos; let i = index">
        <h3>{{ evento.name }}</h3>

        <p><strong>ğŸ“ DirecciÃ³n: </strong> {{ getEventAddress(evento) }}</p>

        <div>
          <strong>ğŸ•’ Horario: </strong>
          <span>{{ getScheduleText(evento) }}</span>
        </div>

        <p>
          <strong>ğŸ‘¥ Participantes: </strong>
          <span>{{ getParticipantsNames(evento) }}</span>
        </p>

<!-- â­ Resumen valoraciones -->
<div class="rating-summary" style="margin-top:8px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
  <strong>â­ Valoraciones:</strong>
  <span *ngIf="evento.ratingsCount && evento.ratingsCount > 0">
    Media {{ evento.avgRating | number:'1.1-2' }} ({{ evento.ratingsCount }} valoraciones)
  </span>
  <span *ngIf="!evento.ratingsCount || evento.ratingsCount === 0">
    Sin valoraciones aÃºn
  </span>

  <button
    type="button"
    class="btn-rate-link"
    (click)="goToRatings(evento)">
    â­ Ver / Valorar
  </button>
</div>


        <div class="actions">
          <button class="btn-edit" (click)="openEditModal(i)">âœï¸ Modificar Evento</button>
          <button class="btn-delete" (click)="openDeleteModal(i)">ğŸ—‘ï¸ Eliminar Evento</button>
        </div>
      </li>
    </ul>
  </div>
</div>

<!-- Modal eliminar -->
<div class="modal-overlay" *ngIf="showDeleteModal">
  <div class="modal">
    <h3>Â¿Eliminar evento?</h3>
    <p>Esta acciÃ³n no se puede deshacer. Se eliminarÃ¡n todos los datos del evento.</p>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeDeleteModal()">Cancelar</button>
      <button class="btn-confirm" (click)="confirmarEliminar()">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal editar -->
<div class="modal-overlay" *ngIf="showEditModal">
  <div class="modal large-modal">
    <div class="modal-header">
      <h3>âœï¸ Modificar Evento</h3>
      <button class="btn-close" (click)="closeEditModal()">Ã—</button>
    </div>

    <form (ngSubmit)="onEditSubmit()">
      <div class="form-group">
        <label for="editName" class="form-label">Titulo del evento:</label>
        <input
          id="editName"
          class="form-input"
          type="text"
          [(ngModel)]="editEvent.name"
          name="editName"
          placeholder="Ej: ReuniÃ³n de planificaciÃ³n Q4"
          required />
      </div>

      <div class="form-two-col">
        <div class="left-col">
          <div class="form-group">
            <label class="form-label">Horario del evento:</label>
            <div class="schedule-row">
              <input 
                type="date" 
                class="form-input"
                [(ngModel)]="editDateStr" 
                name="editDateStr" 
                aria-label="Fecha" />
              <input 
                type="time" 
                class="form-input"
                [(ngModel)]="editTimeStr" 
                name="editTimeStr" 
                aria-label="Hora" />
              <button type="button" (click)="setEditSchedule()" class="add-slot">
                ğŸ“… Actualizar horario
              </button>

              <button
                type="button"
                *ngIf="editEvent.schedule && editEvent.schedule !== ''"
                (click)="clearEditSchedule()"
                class="remove-slot">
                âŒ Quitar
              </button>
            </div>

            <div class="schedule-preview">
              <strong>Horario actual: </strong>
              <span *ngIf="editEvent.schedule; else noEditHorario">
                {{ getScheduleText(editEvent) }}
              </span>
              <ng-template #noEditHorario><em>Sin horario establecido</em></ng-template>
            </div>
          </div>

          <div class="form-group">
            <label for="editAddress" class="form-label">DirecciÃ³n:</label>
            <input
              id="editAddress"
              class="form-input"
              type="text"
              [(ngModel)]="editEvent.address"
              name="editAddress"
              placeholder="Ej: C/ Mallorca 123, Barcelona" />
          </div>
        </div>

        <div class="right-col">
          <div class="participants-wrapper">
            <!-- Edit mode participants management -->
            <div class="participants-column">
              <div class="list-header">
                <h4>ğŸ‘¥ Usuarios disponibles</h4>
              </div>

              <div class="pager">
                <button type="button" (click)="editAvailablePrevPage()" [disabled]="editAvailablePage<=1">Â«</button>
                <span class="counter">PÃ¡gina {{ editAvailablePage }} / {{ editAvailableTotalPages }}</span>
                <button type="button" (click)="editAvailableNextPage()" [disabled]="editAvailablePage>=editAvailableTotalPages">Â»</button>
                <span class="total">Total: {{ editAvailableUsers.length }}</span>
              </div>

              <div class="user-row" *ngFor="let u of editAvailablePageItems">
                <span class="user-name">{{ u.username }}</span>
                <button type="button" (click)="addEditParticipant(u)" class="btn-add">â• AÃ±adir</button>
              </div>
              <div class="empty" *ngIf="!editAvailableUsers.length">
                âœ… Todos los usuarios estÃ¡n en el evento
              </div>
            </div>

            <div class="participants-column">
              <div class="list-header">
                <h4>ğŸ¯ Participantes del evento</h4>
              </div>

              <div class="pager">
                <button type="button" (click)="editSelectedPrevPage()" [disabled]="editSelectedPage<=1">Â«</button>
                <span class="counter">PÃ¡gina {{ editSelectedPage }} / {{ editSelectedTotalPages }}</span>
                <button type="button" (click)="editSelectedNextPage()" [disabled]="editSelectedPage>=editSelectedTotalPages">Â»</button>
                <span class="total">Total: {{ editSelectedUsers.length }}</span>
              </div>

              <div class="user-row" *ngFor="let u of editSelectedPageItems">
                <span class="user-name">{{ u.username }}</span>
                <button type="button" (click)="removeEditParticipant(u)" class="btn-remove">â– Quitar</button>
              </div>
              <div class="empty" *ngIf="!editSelectedUsers.length">
                â„¹ï¸ Nadie apuntado aÃºn
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="closeEditModal()">Cancelar</button>
        <button type="submit" class="btn-confirm">ğŸ’¾ Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>